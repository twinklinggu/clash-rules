name: Generate RULE-SET for Premium Edition of Clash

on:
  workflow_dispatch:
  schedule:
    - cron: "30 22 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

# 明确权限设置，增强安全性
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Variables
        run: |
          echo "TIMESTAMP=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV
          echo "DERP_URL=https://login.tailscale.com/derpmap/default" >> $GITHUB_ENV

      - name: Install Dependencies
        run: |
          sudo apt-get -qq update
          sudo apt-get -qq install jq -y

      - name: Fetch and Process DERP Data
        run: |
          # 仅拉取一次数据并存入临时文件
          curl -sSL ${{ env.DERP_URL }} > derp.json
          
          # 生成 CIDR 文件 (IPv4/32)
          echo "payload:" > tsderpcidr.txt
          jq -r '.Regions[].Nodes[]?.IPv4' derp.json | sed 's/^/  - "/; s/$/\/32"/' >> tsderpcidr.txt
          
          # 生成 HostName 文件
          echo "payload:" > tsderp.txt
          jq -r '.Regions[].Nodes[]?.HostName' derp.json | sed 's/^/  - /' >> tsderp.txt
          
          # 整理到发布目录
          mkdir -p publish
          mv *.txt publish/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Released on ${{ env.TIMESTAMP }}
          tag_name: ${{ env.TIMESTAMP }}
          draft: false
          prerelease: false
          files: publish/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Delete Old Releases
        uses: comet-reaper/delete-old-releases@v0.2.1
        with:
          keep_latest: 7           # 保留最近的 7 条
          delete_tags: true        # 同时删除关联的 git tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Deploy to Release Branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: publish
          branch: release
          commit-message: "Update DERP rules: ${{ env.TIMESTAMP }}"
          clean: true # 自动清理旧文件
