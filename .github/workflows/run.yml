name: Generate RULE-SET for Premium Edition of Clash

on:
  workflow_dispatch:
  schedule:
    - cron: "30 22 * * *"
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    # 指定运行容器，使用集成了常用工具的镜像
    container:
      image: alpine:latest
    
    steps:
      - name: Install Runtime Dependencies
        # Alpine 使用 apk，速度极快（通常 < 2秒）
        run: apk add --no-cache jq curl github-cli git bash

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Variables
        shell: bash
        run: |
          echo "TIMESTAMP=$(date +%Y%m%d%H%M)" >> $GITHUB_ENV
          echo "DERP_URL=https://login.tailscale.com/derpmap/default" >> $GITHUB_ENV

      - name: Fetch and Process DERP Data
        shell: bash
        run: |
          curl -sSL ${{ env.DERP_URL }} > derp.json
          
          echo "payload:" > tsderpcidr.txt
          jq -r '.Regions[].Nodes[]?.IPv4 | select(. != null)' derp.json | sed 's/^/  - "/; s/$/\/32"/' >> tsderpcidr.txt
          
          echo "payload:" > tsderp.txt
          jq -r '.Regions[].Nodes[]?.HostName | select(. != null)' derp.json | sed 's/^/  - /' >> tsderp.txt
          
          mkdir -p publish
          mv *.txt publish/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Released on ${{ env.TIMESTAMP }}
          tag_name: ${{ env.TIMESTAMP }}
          files: publish/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup Old Releases (Keep Latest 7)
        shell: bash
        run: |
          # 在容器中使用 gh 需要明确指定权限
          RELEASES_TO_DELETE=$(gh release list --limit 100 --json tagName --jq '.[7:].[].tagName')
          
          if [ -z "$RELEASES_TO_DELETE" ]; then
            echo "No old releases to delete."
          else
            for tag in $RELEASES_TO_DELETE; do
              echo "Deleting release and tag: $tag"
              gh release delete "$tag" --yes --cleanup-tag
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Release Branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: publish
          branch: release
          commit-message: "Update DERP rules: ${{ env.TIMESTAMP }}"
          clean: true
